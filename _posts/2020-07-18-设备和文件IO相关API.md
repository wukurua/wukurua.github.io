---
layout:     post
title:      è®¾å¤‡å’Œæ–‡ä»¶IOç›¸å…³API
subtitle:   
date:       2020-07-18
author:     wukurua
header-img: img/linux/post-bg-linux.png
catalog: true
tags:
    - linux
---

# ä¸€ã€Linuxä¸­çš„è®¾å¤‡ç®¡ç†

Linuxé‡‡ç”¨æ–‡ä»¶ç³»ç»Ÿç®¡ç†ç¡¬ä»¶è®¾å¤‡ï¼Œ**æ‰€æœ‰çš„è®¾å¤‡éƒ½çœ‹æˆæ˜¯ç‰¹æ®Šçš„æ–‡ä»¶**ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºéƒ½æ˜¯ç³»ç»Ÿå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬å¿…é¡»ä¸ºç³»ç»Ÿå†…æ ¸æˆ–è€…å®ƒä»¬çš„å­ç³»ç»Ÿæä¾›ä¸€ä¸ªæ ‡å‡†çš„æ¥å£ï¼Œå¯¹è®¾å¤‡çš„ä½¿ç”¨ç±»ä¼¼äºå¯¹æ–‡ä»¶çš„å­˜å–,ä»è€Œå°†ç¡¬ä»¶è®¾å¤‡çš„ç‰¹æ€§åŠç®¡ç†ç»†èŠ‚å¯¹ç”¨æˆ·éšè—èµ·æ¥ï¼Œå®ç°**è®¾å¤‡æ— å…³æ€§**ã€‚

## 1.ç³»ç»Ÿè°ƒç”¨æ˜¯æ“ä½œç³»ç»Ÿæä¾›ç»™ç”¨æˆ·çš„ä¸€ç»„â€œç‰¹æ®Šâ€æ¥å£

ç³»ç»Ÿè°ƒç”¨å¹¶éç›´æ¥å’Œç¨‹åºå‘˜æˆ–ç³»ç»Ÿç®¡ç†å‘˜ç›´æ¥æ‰“äº¤é“ï¼Œè€Œæ˜¯é€šè¿‡è½¯ä¸­æ–­çš„æ–¹å¼å‘å†…æ ¸æäº¤è¯·æ±‚ï¼Œä»è€Œè·å–å†…æ ¸å‡½æ•°çš„æœåŠ¡å…¥å£ï¼ˆç³»ç»Ÿè°ƒç”¨è¡¨ï¼‰ã€‚ç³»ç»Ÿè°ƒç”¨è®©ç³»ç»Ÿä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸ç©ºé—´å†…è¿è¡Œï¼Œè¿è¡Œåå°†ç»“æœè¿”å›ç»™åº”ç”¨ç¨‹åºï¼ˆå†…æ ¸æ€->ç”¨æˆ·æ€ï¼‰ã€‚

<img src="https://cdn.jsdelivr.net/gh/wukurua/cloudimg@master/img/20200725162755.png" style="zoom: 80%;" />

## 2.ç³»ç»Ÿè°ƒç”¨å’Œç³»ç»ŸAPIçš„åŒºåˆ«

- ç³»ç»ŸAPIä¸»è¦æ˜¯é€šè¿‡Cåº“libcæ¥å®ç°ï¼Œç¨‹åºå‘˜å¤šé‡‡ç”¨è¿™ç§æ–¹å¼ä¸å†…æ ¸äº¤äº’ï¼Œè¿™äº›APIé€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å®ç°

- ç³»ç»Ÿå‘½ä»¤ç³»ç»Ÿç®¡ç†å‘˜é‡‡ç”¨ç³»ç»Ÿå‘½ä»¤ä¸å†…æ ¸äº¤äº’ï¼Œæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šè¿‡ç³»ç»ŸAPIåŠç³»ç»Ÿè°ƒç”¨æ¥å®ç°

<img src="https://cdn.jsdelivr.net/gh/wukurua/cloudimg@master/img/20200725163803.png" style="zoom:80%;" />

# äºŒã€æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨API

**æ–‡ä»¶æè¿°ç¬¦fd**

- æ¯ä¸ªè¿›ç¨‹**PCB**ç»“æ„ä¸­æœ‰æ–‡ä»¶æè¿°ç¬¦æŒ‡é’ˆï¼ŒæŒ‡å‘`files_struct`çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œè®°å½•æ¯ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶åˆ—è¡¨ã€‚

- ç³»ç»Ÿå†…æ ¸ä¸å…è®¸åº”ç”¨ç¨‹åºè®¿é—®è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œåªè¿”å›è¿™äº›ç»“æ„çš„ç´¢å¼•å³æ–‡ä»¶æè¿°ç¬¦ID(File Description)ç»™åº”ç”¨ç¨‹åºã€‚Linuxç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡è¿™äº›æ–‡ä»¶æè¿°ç¬¦æ¥å®ç°è®©å†…æ ¸å¯¹æ–‡ä»¶çš„è®¿é—®

æŸ¥çœ‹linuxç³»ç»Ÿé‡Œæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æœ€å¤§å€¼ï¼Œä¸€èˆ¬ç¼ºçœå€¼æ˜¯1024ã€‚

```c
chenling@chenling-virtual-machine:~$ ulimit -n
1024
```

å…·ä½“çš„ï¼Œè¿™ç¯‡ä»‹ç»çš„å¾ˆå¥½ğŸ‘‰[Linuxæ–‡ä»¶æè¿°ç¬¦](https://www.jianshu.com/p/cded914786d5)

## 1. open&close

`open`

NAME
       open, openat, creat - open and possibly create a file

SYNOPSIS

    #include <sys/types.h>
    #include <sys/stat.h>
    #include <fcntl.h>
    
    int open(const char *pathname, int flags);
    int open(const char *path, int flags,mode_t mode);

å‚æ•°ï¼š

- flagsï¼šæ–‡ä»¶æ‰“å¼€æ¨¡å¼
- mode:ï¼šç”¨æ¥è§„å®šå¯¹è¯¥æ–‡ä»¶çš„æ‰€æœ‰è€…ï¼Œæ–‡ä»¶çš„ç”¨æˆ·ç»„åŠç³»ç»Ÿä¸­å…¶ä»–ç”¨æˆ·çš„è®¿é—®æƒé™ï¼Œåˆ™æ–‡ä»¶æƒé™ä¸ºï¼šmode&(~umask)

è¿”å›å€¼:

- æ‰“å¼€æˆåŠŸï¼Œè¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼›
- æ‰“å¼€å¤±è´¥ï¼Œè¿”å›ï¼1

```c
#include <fcntl.h>
```

|   æ‰“å¼€æ–¹å¼   |                      æè¿°                       |
| :----------: | :---------------------------------------------: |
| **O_RDONLY** |              æ‰“å¼€ä¸€ä¸ªä¾›è¯»å–çš„æ–‡ä»¶               |
| **O_WRONLY** |              æ‰“å¼€ä¸€ä¸ªä¾›å†™å…¥çš„æ–‡ä»¶               |
|  **O_RDWR**  |             æ‰“å¼€ä¸€ä¸ªå¯ä¾›è¯»å†™çš„æ–‡ä»¶              |
|   O_APPEND   |       å†™å…¥çš„æ‰€æœ‰æ•°æ®å°†è¢«è¿½åŠ åˆ°æ–‡ä»¶çš„æœ«å°¾        |
| **O_CREAT**  |       æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™å»ºç«‹æ–‡ä»¶        |
|    O_EXCL    | å¦‚æœå·²ç»ç½®O_CREATä¸”æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™å¼ºåˆ¶openï¼ˆï¼‰å¤±è´¥ |
| **O_TRUNC**  |         åœ¨openï¼ˆï¼‰æ—¶ï¼Œå°†æ–‡ä»¶çš„å†…å®¹æ¸…ç©º          |

`close`

NAME
       close - close a file descriptor

SYNOPSIS

    #include <unistd.h>
    int close(int fd);

## 2. read&write

`read`

NAME
       read - read from a file descriptor

SYNOPSIS

     #include <unistd.h>
     ssize_t read(int fd, void *buf, size_t count);

å‚æ•°ï¼š

- fd ï¼šæƒ³è¦è¯»çš„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦
- buf: æŒ‡å‘å†…å­˜å—çš„æŒ‡é’ˆï¼Œä»æ–‡ä»¶ä¸­è¯»å–æ¥çš„å­—èŠ‚æ”¾åˆ°è¿™ä¸ªå†…å­˜å—ä¸­
- nbytes: ä»è¯¥æ–‡ä»¶å¤åˆ¶åˆ°bufä¸­çš„å­—èŠ‚ä¸ªæ•°

è¿”å›å€¼

- å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¿”å›-1
- è¿”å›ä»è¯¥æ–‡ä»¶å¤åˆ¶åˆ°è§„å®šçš„ç¼“å†²åŒºä¸­çš„å­—èŠ‚æ•°,æ–‡ä»¶ç»“æŸï¼Œè¿”å›0

`write`

NAME
       write - write to a file descriptor

SYNOPSIS

    #include <unistd.h>
    ssize_t write(int fd, const void *buf, size_t count);

å‚æ•°ï¼š

- fd ï¼šæƒ³è¦è¯»çš„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦
- bufï¼šæŒ‡å‘å†…å­˜å—çš„æŒ‡é’ˆï¼Œä»è¿™ä¸ªå†…å­˜å—ä¸­è¯»å–æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­
- nbytes:ï¼š**ä»è¯¥æ–‡ä»¶å¤åˆ¶åˆ°bufä¸­çš„å­—èŠ‚ä¸ªæ•°**

è¿”å›å€¼

- å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¿”å›-1
- å¦‚æœå†™å…¥æˆåŠŸï¼Œåˆ™è¿”å›å†™å…¥åˆ°æ–‡ä»¶ä¸­çš„å­—èŠ‚ä¸ªæ•°

## 3. lseek

NAME
       lseek - reposition read/write file offset

SYNOPSIS

    #include <sys/types.h>
    #include <unistd.h>
    off_t lseek(int fd, off_t offset, int whence);

å‚æ•°ï¼š

- fd ï¼šéœ€è®¾ç½®çš„æ–‡ä»¶æ ‡è¯†ç¬¦
- offsetï¼šåç§»é‡
- whence:ï¼šæœç´¢çš„èµ·å§‹ä½ç½®

```c
#include <unistd.h>
```

|  whence  |          æ–‡ä»¶ä½ç½®          |
| :------: | :------------------------: |
| SEEK_SET |    ä»æ–‡ä»¶å¼€å§‹å¤„è®¡ç®—åç§»    |
| SEEK_CUR | ä»å½“å‰æ–‡ä»¶çš„åç§»å€¼è®¡ç®—åç§» |
| SEEK_END |   ä»æ–‡ä»¶çš„ç»“æŸå¤„è®¡ç®—åç§»   |

è¿”å›å€¼

- å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¿”å›-1
- å¦‚æœå†™å…¥æˆåŠŸï¼Œåˆ™è¿”å›å†™å…¥åˆ°æ–‡ä»¶ä¸­çš„å­—èŠ‚ä¸ªæ•°

## ä¸¾ä¾‹

```c
#include <iostream>
#include <unistd.h>
#include <sys/types.h>
#include <sys/fcntl.h>
#include <sys/stat.h>
#include <stdio.h>
#include <strings.h>
#include <string.h>
#include <dirent.h>
#include <fcntl.h>
using namespace std;

int main()
{
    int fd=-1;
    fd=open("/mnt/hgfs/share_ubuntu16.04/mimi.txt",O_RDWR|O_CREAT);
    if(fd<0)
    {
        perror("write file error");
        return -1;
    }
    char buffer[50]={0};
    memset(buffer,0,sizeof(buffer));
    strcpy(buffer,"hello linux!");
    int r_size=0,w_size=0,seek_size=0;
    seek_size=lseek(fd,60,SEEK_SET);
    w_size=write(fd,buffer,strlen(buffer));
    seek_size=lseek(fd,0,SEEK_SET);
    if(seek_size<0)
    {
        perror("seek error");
        return -1;
    }
    memset(buffer,0,sizeof(buffer));
    while((r_size=read(fd,buffer,sizeof(buffer)))>0)
    {
        memset(buffer,0,sizeof(buffer));
    }
    close(fd);
    return 0;
}
```

## 4.





```c++
#include <iostream>
#include <unistd.h>
#include <sys/types.h>
#include <sys/fcntl.h>
#include <sys/stat.h>
#include <stdio.h>
#include <strings.h>
#include <string.h>
#include <dirent.h>
#include <fcntl.h>
using namespace std;

int main()
{
//    int fd=-1;
//    fd=open("/mnt/hgfs/share_ubuntu16.04/mimi.txt",O_RDWR|O_CREAT);
//    if(fd<0)
//    {
//        perror("write file error");
//        return -1;
//    }
//
//    char buffer[20]={0};
//    memset(buffer,0,sizeof(buffer));
//    strcpy(buffer,"hello linux!");
//    int r_size=0,w_size=0,seek_size=0;
//    seek_size=lseek(fd,60,SEEK_SET);
//    w_size=write(fd,buffer,strlen(buffer));
//    seek_size=lseek(fd,0,SEEK_SET);
//    if(seek_size<0)
//    {
//        perror("seek error");
//        return -1;
//    }
//    cout<<"seek_size="<<seek_size<<endl;
//    memset(buffer,0,sizeof(buffer));
//    r_size=read(fd,buffer,sizeof(buffer));
//    while(r_size>0)
//    {
//        cout<<"buffer:"<<buffer<<endl;
//        cout<<"r_size="<<r_size<<endl;
//        memset(buffer,0,sizeof(buffer));
//        r_size=read(fd,buffer,sizeof(buffer));
//    }
//    close(fd);
    int res=-1;
    res=chmod("/mnt/hgfs/share_ubuntu16.04/mimi.txt",0775);
    if(res!=NULL)
    {
        perror("chmod error");
        return -1;
    }
    

    int fd=-1;
    fd=open("/mnt/hgfs/share_ubuntu16.04/mimi.txt",O_RDWR|O_CREAT);
    if(fd<0)
    {
        perror("write file error");
        return -1;
    }
    if(fcntl(fd,F_GETLK,&lock)==0)
    {
        if(lock.l_type==F_WRLCK)
        {
            cout<<"write lock is locked!"<<endl;
            return -1;
        }
        else if(lock.l_type!=F_WRLCK)
        {
            lock.l_type=F_WRLCK;
            if(fcntl(fd,F_SETLK,&lock)==0)
            {
                cout<<"set write lolck sus!"<<endl;
            }
            else
            {
                cout<<"set write lolck failed!"<<endl;
            }
        }
        //process run
        sleep(10);
        lock.l_type=F_UNLCK;
        fcntl(fd,F_SETLK,&lock);
    }
    return 0;

```

